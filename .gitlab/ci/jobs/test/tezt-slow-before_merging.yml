# This file was automatically generated, do not edit.
# Edit file ci/bin/main.ml instead.

tezt-slow:
  image: ${build_deps_image_name}:runtime-e2etest-dependencies--${build_deps_image_version}
  stage: test
  tags:
  - gcp_tezt
  rules:
  - changes:
    - .gitlab-ci.yml
    - .gitlab/**/*
    - etherlink/**/*
    - michelson_test_scripts/**/*
    - src/**/*
    - tezt/**/*
    - tzt_reference_test_suite/**/*
    when: manual
    allow_failure: true
  needs:
  - select_tezts
  - oc.build_x86_64-released
  - oc.build_x86_64-exp-dev-extra
  - oc.build_kernels
  - oc.tezt:fetch-records
  dependencies:
  - select_tezts
  - oc.build_x86_64-released
  - oc.build_x86_64-exp-dev-extra
  - oc.build_kernels
  - oc.tezt:fetch-records
  before_script:
  - . ./scripts/version.sh
  - eval $(opam env)
  script:
  - echo "TESTS=\"${TESTS}\" JUNIT=\"${JUNIT}\" CI_NODE_INDEX=\"${CI_NODE_INDEX}\"
    CI_NODE_TOTAL=\"${CI_NODE_TOTAL}\" TEZT_PARALLEL=\"${TEZT_PARALLEL}\" TEZT_VARIANT=\"${TEZT_VARIANT}\""
  - ./scripts/ci/tezt.sh "${TESTS}" --from-record tezt/records --job ${CI_NODE_INDEX:-1}/${CI_NODE_TOTAL:-1}
    --list-tsv > selected_tezts.tsv
  - ./scripts/ci/exit_code.sh timeout -k 60 1860 ./scripts/ci/tezt.sh "${TESTS}" --color
    --log-buffer-size 5000 --log-file tezt.log --global-timeout 1800 --on-unknown-regression-files
    fail --junit ${JUNIT} --from-record tezt/records --job ${CI_NODE_INDEX:-1}/${CI_NODE_TOTAL:-1}
    --record tezt-results-${CI_NODE_INDEX:-1}${TEZT_VARIANT}.json --job-count ${TEZT_PARALLEL}
    --retry ${TEZT_RETRY}
  - if [ -n "${BISECT_FILE:-}" ]; then ./scripts/ci/merge_coverage.sh; fi
  variables:
    JUNIT: tezt-junit.xml
    TEZT_VARIANT: -slow
    TESTS: slow && /ci_disabled && /memory_3k && /memory_4k && /time_sensitive &&
      /cloud && not (file = src/proto_019_PtParisA/lib_protocol/test/integration/test_adaptive_issuance_launch.ml)
    TEZT_RETRY: "1"
    TEZT_PARALLEL: "3"
  artifacts:
    expire_in: 7 days
    paths:
    - selected_tezts.tsv
    - tezt.log
    - tezt-*.log
    - tezt-results-${CI_NODE_INDEX:-1}${TEZT_VARIANT}.json
    - $JUNIT
    reports:
      junit: $JUNIT
    when: always
  retry: 2
  parallel: 10
