<!doctype html>

<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Endorsement reception delays</title>
    <script src=https://cdnjs.cloudflare.com/ajax/libs/mathjs/3.3.0/math.min.js></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7.4.4/dist/d3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.27.2/axios.min.js"
        integrity="sha512-odNmoc1XJy5x1TMVMdC7EMs3IVdItLPlCeL5vSUPN2llYKMJ2eByTTAIiiuqLg+GdNr9hF6z81p27DArRFKT7A=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

</head>

<body>
    <script type="text/javascript" src="./js/populate_sort_data.js"></script>
    <form>
        <h1>Endorsement reception delays</h1>
        <label for="selectedLevel">Level</label>
        <tr>
            <td rowspan="2">
                <input name="level" id="selectedLevel" type="text" value="1229476" />
            </td>
            <td>
                <input id="plus" type="button" value=" Next " onclick="this.form.level.value++;">
            </td>
        </tr>
        <tr>
            <td><input id="moins" type=button value=" Previous " onclick="this.form.level.value--;"></td>
        </tr>
    </form>
    <script>
        var directories = {};
        var va;// = "2369254"; //#block
        var dict_data = {};
        const server_adress = "http://78.193.200.52/";
        var t_op_valide = {}; // contient plusieurs dict, chacun associé à un round. Ces dict contiennent 2 listes, qui sont les délais de réception pour les Préendorsement et les endorsmenet valides 
        var t_op_erreur = { "avance": { "t_approbations": [], "t_pre_approbations": [] } }; // contient plusieurs dict, chacun associé à un round. Ces dict contiennent 2 listes, qui sont les délais de réception pour les Préendorsement et les endorsmenet invalides ( PS: avance car ces OP sont reçus par le noeud avant le bloc canidat !)
        var t_baker = {}; // date de préparation supposé dans le fichier qui correspond au nom et date de publication dans le fichier suivant(c'est à ce moment qu'il est visible pour les délégués)
        var t_recep = {}; // date de réception du bloc 
        var t_delai_bloc = {};
        var max_round; // round final du bloc
        var ano_desc = {}; // COntient les différentes catégories d'opérations, ainsi qu'une liste des délégué associé aux op de chaque catégorie

        
        function MessageErreur() {
            try {
                const elements5 = document.querySelector("p");
                const myNode = document.querySelector("p");;
                while (myNode.firstChild) {
                    myNode.removeChild(myNode.lastChild);
                }
            } catch (e) {
                console.log(e)
            }
            try {
                const elements2 = document.getElementById("tab_delegates").querySelector("h2")
                elements2.parentElement.removeChild(elements2);
            } catch (e) {
                //console.log(e)
            }
            try {
                const elements = document.getElementById("tab_delegates").querySelector("table");
                elements.parentElement.removeChild(elements);
            } catch (e) {
                // console.log(e)
            }

            try {
                while (document.getElementById("resume").querySelector("h2")) {
                    const elements3 = document.getElementById("resume").querySelector("h2");
                    document.getElementById("resume").removeChild(elements3);
                }
            } catch (e) {
                console.log(e)
            }
            try {
                const elements4 = document.getElementById("resume").querySelector("table");
                elements4.parentElement.removeChild(elements4);
            } catch (e) {
                //console.log(e)
            }
            if (document.getElementById("resume").querySelector("h2")) {

            }
            else {
                var mess_erreur = document.createElement('h2');
                mess_erreur.appendChild(document.createTextNode("Oops, i can't find this block !"));
                document.getElementById("resume").appendChild(mess_erreur);
            }

        }
        async function main() {
            try {

                $.get(server_adress, null, function (text) {
                    //directories=$(text).find("a").text(); //fonctionne !!! 
                    $(text).find("a").each(function () {
                        let s = $(this).text();
                        //console.log(typeof(s));
                        if (s.includes('-') == true) {
                            //console.log(s);
                            var minmax = s.split('-');
                            if (+minmax[0] > 0 && +minmax[1] > 0) { // filtrer les autres fichiers 
                                directories[s] = [+minmax[0], +minmax[1]]
                            }


                        }
                    })
                    //Réagir à la saisie de texte
                    $('form').keyup(async function (e) {
                        var va = e.target.value;
                        //visualise(va);
                        await populate_v0(server_adress, va, va, directories, dict_data);
                        await tri_endorsement_reception_delays_for_a_block(va, dict_data);
                
                    });

                    //Réagir à un click sur les boutons 
                    $('#plus').click(async function () {

                        va = document.getElementById('selectedLevel').value;
                        await populate_v0(server_adress, va, va, directories, dict_data);
                        //console.log(dict_data)
                        await delay(1000)
                        await tri_endorsement_reception_delays_for_a_block(va, dict_data);
                        
                    });

                    $('#moins').click(async function () {

                        va = document.getElementById('selectedLevel').value;
                        await populate_v0(server_adress, va, va, directories, dict_data);
                        await delay(1000)
                        await tri_endorsement_reception_delays_for_a_block(va, dict_data);
                        
                    });

                });

            } catch (erreur) {
                console.log(erreur);
            }
        }
        const delay =
    milliseconds =>
    new Promise(resolve =>
        setTimeout(resolve, milliseconds));
        
        main()

    </script>
    <p></p>
    <br>
    <br>
    <div id="tab_delegates"></div>
    <div id="resume"></div>
</body>