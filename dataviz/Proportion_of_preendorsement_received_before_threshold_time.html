<!doctype html>

<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Preendorsement inclusion based on threshold time</title>
    <script src=https://cdnjs.cloudflare.com/ajax/libs/mathjs/3.3.0/math.min.js></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7.4.4/dist/d3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.13.0/d3-legend.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.27.2/axios.min.js"
        integrity="sha512-odNmoc1XJy5x1TMVMdC7EMs3IVdItLPlCeL5vSUPN2llYKMJ2eByTTAIiiuqLg+GdNr9hF6z81p27DArRFKT7A=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>

<body>
    <script type="text/javascript" src="./js/populate_sort_data.js"></script>

    <h1> Proportion of preendorsement received before threshold time</h1>
    <form>
        <div>
            <label for="selectedLevel_begin">First Bloc:</label>
            <input name="level_" id="selectedLevel_begin" type="number" value="2412550" />
            <span id='tick_begin'></span>
            <br>
            <label for="selectedLevel_end">Last bloc:</label>
            <input name="level_" id="selectedLevel_end" type="number" value="2412700" />
            <span id='tick_end'></span>
            <br>
            <label for="selectedThreshold">Temporal threshold:</label>
            <input name="threshold" id="selectedThreshold" type="number" value="15" />
            <br>
            <input type="button" id="submit_" value="Rechercher ">

        </div>
    </form>
    <script>

        const server_adress = "http://78.193.200.52";
        var directories = {};
        var dict_data = {};
        var directories = {};
        var t_op_pre_valide = {}; // contient plusieurs dict, chacun associé à un round. Ces dict contiennent 2 listes, qui sont les délais de réception pour les Préendorsement et les endorsmenet invalides 
        var t_baker; // date de préparation supposé dans le fichier qui correspond au nom et date de publication dans le fichier suivant(c'est à ce moment qu'il est visible pour les délégués)
        var t_recep; // date de réception du bloc 
        const delay =
            milliseconds =>
                new Promise(resolve =>
                    setTimeout(resolve, milliseconds));
        async function main() {
            try {
                
                $.get(server_adress, null, function (text) {
                    //directories=$(text).find("a").text(); //fonctionne !!! 
                    $(text).find("a").each(function () {
                        let s = $(this).text();
                        //console.log(typeof(s));
                        if (s.includes('-') == true) {
                            //console.log(s);
                            var minmax = s.split('-');
                            if (+minmax[0] > 0 && +minmax[1] > 0) { // filtrer les autres fichiers 
                                directories[s] = [+minmax[0], +minmax[1]]
                            }


                        }
                    })
                    $('#submit_').mouseup(async function (e) {
                        beg_ = document.getElementById('selectedLevel_begin').value;
                        end_ = document.getElementById('selectedLevel_end').value;
                        threshold_ = document.getElementById('selectedThreshold').value;
                        await populate_v0(server_adress, beg_, end_, directories, dict_data);
                        await delay((end_-beg_)*100)
                        console.log(dict_data)
                        await tri_greeks(dict_data);
                        await delay(3000)
                        const results = await percIntegration(threshold_, t_op_pre_valide)
                        await delay(1000)
                        console.log(results)
                        chart_alpha(results)

                    });

                })
            } catch (e) {
                console.log(e)
            }
        }
        main()

    </script>
    <div id="alpha"></div>

</body>