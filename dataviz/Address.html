<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Adress Endorsement reception delays</title>
    <script src=https://cdnjs.cloudflare.com/ajax/libs/mathjs/3.3.0/math.min.js></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7.4.4/dist/d3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.13.0/d3-legend.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.27.2/axios.min.js"
        integrity="sha512-odNmoc1XJy5x1TMVMdC7EMs3IVdItLPlCeL5vSUPN2llYKMJ2eByTTAIiiuqLg+GdNr9hF6z81p27DArRFKT7A=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

</head>

<body>
    <script type="text/javascript" src="./js/populate_sort_data.js"></script>
    <script type="text/javascript" src="./js/local_config.js"></script>

    <h1> Adress Endorsement reception delays </h1>
    <form>
        <div>
            <label for="selectedLevel_begin">First bloc:</label>
            <input name="level_" id="selectedLevel_begin" type="number" />
            <span id='tick_begin'></span>
            <br>
            <label for="selectedLevel_end">Last bloc:</label>
            <input name="level_" id="selectedLevel_end" type="number" />
            <span id='tick_end'></span>
            <br>
            <label for="adress_">delegate adress:</label>
            <input name="adress_" id="adress_" type="string" value="tz1Ro4GjLWajnL7FWE1RxFTweLwsGdPqKbdZ" />
            <input type="button" id="submit_" value="Search ">
            

        </div>
    </form>
    <script>
        var dict_data = {};
        function main() {
            try {
               // parameter from URL  
               const params = new Proxy(new URLSearchParams(window.location.search), { // to input parameters in URL
                    get: (searchParams, prop) => searchParams.get(prop),
                });
                // Get the value of "some_key" in eg "https://example.com/?some_key=some_value"
                let first_block; // "some_value"
                let last_block;
                let address;
                console.log(parseInt(params.first_block),parseInt(params.last_block), isNaN(params.address))
                if((!(isNaN(parseInt(params.first_block))))&&(!(isNaN(parseInt(params.last_block))))&&(params.address)){
                    
                    first_block = parseInt(params.first_block);
                    document.getElementById("selectedLevel_begin").value = first_block;             

                    last_block = parseInt(params.last_block);
                    document.getElementById("selectedLevel_end").value = last_block;             

                    address =params.address;
                    document.getElementById("adress_").value = address;             

                    let dict_data = populate_v1(server_adress, first_block, last_block).then(dict_data => {
                        let t_valide=delegate_delays_distribution_of_operations(dict_data, address,true);
                        console.log(t_valide);
                        let ope_observation = classify_operations(dict_data, address,true);
                        console.log("ope_observation",ope_observation);
                        let result = get_info_block(dict_data,true);
                        let t_baker=result[1]
                        chart_consensus_operation_specific_address(t_valide);
                        chart_time_mean_deviation(t_valide);
                        resume_obs(ope_observation,t_baker, address);
                    });

                }else if(params.address){
                    console.log("ah",console.log(params.address))
                    address =params.address;
                    var a = getHead(server_adress); // https://stackoverflow.com/questions/28250680/how-do-i-access-previous-promise-results-in-a-then-chain
                    var b= a.then(level=>{
                        return populate_v1(server_adress, level-50, level);
                    });
                    Promise.all([a,b]).then(([block_value,dict_data])=>{
                        document.getElementById("selectedLevel_begin").value = block_value-50;             
                        document.getElementById("selectedLevel_end").value = block_value;             
                        
                        let t_valide=delegate_delays_distribution_of_operations(dict_data, address,true);
                        console.log(t_valide);
                        let ope_observation = classify_operations(dict_data, address,true);
                        console.log("ope_observation",ope_observation);
                        let result = get_info_block(dict_data,true);
                        let t_baker=result[1]
                        chart_consensus_operation_specific_address(t_valide);
                        chart_time_mean_deviation(t_valide);
                        resume_obs(ope_observation,t_baker, address);
                    });

                }
                else{
                    address =document.getElementById("adress_").value;
                    var a = getHead(server_adress); // https://stackoverflow.com/questions/28250680/how-do-i-access-previous-promise-results-in-a-then-chain
                    var b= a.then(level=>{
                        return populate_v1(server_adress, level-50, level);
                    });
                    Promise.all([a,b]).then(([block_value,dict_data])=>{
                        document.getElementById("selectedLevel_begin").value = block_value-50;             
                        document.getElementById("selectedLevel_end").value = block_value;             
                        
                        let t_valide=delegate_delays_distribution_of_operations(dict_data, address,true);
                        console.log(t_valide);
                        let ope_observation = classify_operations(dict_data, address,true);
                        console.log("ope_observation",ope_observation);
                        let result = get_info_block(dict_data,true);
                        let t_baker=result[1]
                        chart_consensus_operation_specific_address(t_valide);
                        chart_time_mean_deviation(t_valide);
                        resume_obs(ope_observation,t_baker, address);
                    });
                    
                }
                $('#submit_').mouseup(async function (e) {
                    console.log(document.getElementById('adress_').value)
                    if((!(isNaN(document.getElementById('selectedLevel_begin').value)))&&(!(isNaN(document.getElementById('selectedLevel_end').value)))&&(""!=document.getElementById('adress_').value)){
                        window.location = server_adress+"visualization/Address.html?address="+document.getElementById('adress_').value+"&first_block="+document.getElementById('selectedLevel_begin').value +"&last_block="+document.getElementById('selectedLevel_end').value;
                    }else if(""!=(document.getElementById('adress_').value)){
                        window.location = server_adress+"visualization/Address.html?address="+document.getElementById('adress_').value;

                    }
                });

            } catch (e) {
                console.log(e)
            }
        }
        main()


    </script>
    <div id="dataviz"></div>
    <div id="ecart_moyenne"></div>
    <div id="resume"></div>
