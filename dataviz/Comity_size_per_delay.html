<!doctype html>

<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Proportion of endorsement received before mutliples threshold times</title>
    <script src=https://cdnjs.cloudflare.com/ajax/libs/mathjs/3.3.0/math.min.js></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7.4.4/dist/d3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.13.0/d3-legend.js"></script>
</head>

<body>
    <form>
      <h1> Proportion of
        <select id="preendorsement_viewer">
          <option value="true">pre</option>
          <option value="false"></option>
        </select>
        endorsement received before mutliples threshold times </h1>
        <div>
            <label for="selectedLevel_begin">First block:</label>
            <input name="level_" id="selectedLevel_begin" type="number" />
            <br>
            <label for="selectedLevel_end">Last block:</label>
            <input name="level_" id="selectedLevel_end" type="number" />
            <br>
            <label for="selectedThreshold_begin">lower threshold time(second):</label>
            <input name="threshold" id="selectedThreshold_beg" type="number" value="0" />
            <br>
            <label for="selectedThreshold_end">higher threshold time(second):</label>
            <input name="threshold" id="selectedThreshold_end" type="number" value="8" />
            <br>
            <input type="checkbox" id="with_endorsing_power"></input>
            <label for="with_endorsing_power">endorsing power</label>
            <br>
            <input type="button" id="submit_" value="Search ">
        </div>
    </form>
    <div id="gamma"></div>
    <script type="text/javascript" src="./js/populate_sort_data.js"></script>
    <script type="text/javascript" src="./js/local_config.js"></script>
    <script>
        function main() {
            try {
                // Get the value of "some_key" in eg "https://example.com/?some_key=some_value"
                const params = new URLSearchParams(window.location.search);
                let first_block = parseInt(params.get('first_block'));
                let last_block = parseInt(params.get('last_block'));
                let threshold_low = parseInt(params.get('threshold_low'));
                let threshold_high = parseInt(params.get('threshold_high'));
                let no_endorsing_power = params.get('no_endorsing_power') == "true";
                let selected_kind = parseInt(params.get('selected_kind'));

                if (isNaN(threshold_low)) threshold_low = 0;
                if (isNaN(threshold_high)) threshold_high = 8;
                if (isNaN(selected_kind)) selected_kind = 1;
                document.getElementById("selectedThreshold_beg").value = threshold_low;
                document.getElementById("selectedThreshold_end").value = threshold_high;
                document.getElementById("with_endorsing_power").checked = !no_endorsing_power;
                document.getElementById("preendorsement_viewer").selectedIndex = selected_kind;

                getHead(server_adress).then(most_recent_block => {
                    if (isNaN(last_block) || most_recent_block<last_block)
                        last_block = most_recent_block;
                    if (isNaN(first_block) || most_recent_block<first_block)
                        first_block = last_block - 50;
                    document.getElementById("selectedLevel_begin").value = first_block;
                    document.getElementById("selectedLevel_end").value = last_block;

                    const range_t = range(+threshold_low, +threshold_high);
                    console.log("ok", range_t)
                    let dict_data = populate_v1(server_adress, first_block, last_block).then(dict_data => {
                        let endorsing_power = get_endorsing_power(dict_data);
                        let t_op_valide_dict;
                        if (no_endorsing_power)
                            t_op_valide_dict = delays_distribution_of_operations(dict_data);
                        else
                            t_op_valide_dict = delays_distribution_of_operations_w_delegate(dict_data);
                        console.log("endorsing_power", endorsing_power)
                        console.log("t_op_valide_dict", t_op_valide_dict)
                        let results;
                        if (no_endorsing_power)
                            results = SeriesPercIntegration(range_t, t_op_valide_dict[selected_kind])
                        else
                            results = SeriesPercIntegration_w_endorsing_power(range_t, t_op_valide_dict[selected_kind], endorsing_power)
                        chart_preendorsement_inclusion_based_on_multiple_threshold_time(results)
                    });
                });

                $('#submit_').mouseup(async function (e) {
                    let location_web = String(window.location.href).split('?')[0]
                    if ((!(isNaN(document.getElementById('selectedLevel_begin').value))) && (!(isNaN(document.getElementById('selectedLevel_end').value))) && (!(isNaN(document.getElementById('selectedThreshold_beg').value))) && (!(isNaN(document.getElementById('selectedThreshold_end').value)))) {
                        window.location = location_web + "?threshold_low=" + document.getElementById('selectedThreshold_beg').value + "&threshold_high=" + document.getElementById('selectedThreshold_end').value + "&first_block=" + document.getElementById('selectedLevel_begin').value + "&last_block=" + document.getElementById('selectedLevel_end').value + "&no_endorsing_power=" + !document.getElementById('with_endorsing_power').checked + "&selected_kind=" + document.getElementById('preendorsement_viewer').selectedIndex;
                    }
                });
            } catch (e) {
                console.log(e)
            }
        }
      main()
    </script>
