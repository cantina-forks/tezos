<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Time required to receive n% of validated endorsements</title>
    <script src=https://cdnjs.cloudflare.com/ajax/libs/mathjs/3.3.0/math.min.js></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7.4.4/dist/d3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.13.0/d3-legend.js"></script>
</head>

<body>
    <script type="text/javascript" src="./js/populate_sort_data.js"></script>
    <script type="text/javascript" src="./js/local_config.js"></script>
    <h1> Time required to receive n% of validated endorsements</h1>
    <form>
        <div>
            <label for="selectedLevel_begin">First block:</label>
            <input name="level_" id="selectedLevel_begin" type="number" value="179000" />
            <span id='tick_begin'></span>
            <br>
            <label for="selectedLevel_end">Last block:</label>
            <input name="level_" id="selectedLevel_end" type="number" value="179050" />
            <span id='tick_end'></span>
            <br>
            <label for="selectedThreshold">Percentage threshold (n):</label>
            <input name="threshold" id="selectedThreshold" type="number" value="100" />
            <br>
            <input type="button" id="submit_" value="Search ">
            <br>

        </div>
        <div id="beta"></div>
        <div id="statut">
            <strong>
                <label for="progress">Visualizing progress:</label>
                <span id="progress"> </span>
            </strong>
        </div>
        <style type="text/css">
            #statut {
                position: absolute;
                top: 10;
                right: 10;
                border-radius: 20px;
                border: 2px solid #73AD21;
                padding: 5px;

            }
        </style>
    </form>
    <script>
        
        function main() {
            try {

                const params = new Proxy(new URLSearchParams(window.location.search), { // to input parameters in URL
                    get: (searchParams, prop) => searchParams.get(prop),
                });
                // Get the value of "some_key" in eg "https://example.com/?some_key=some_value"
                let first_block; // "some_value"
                let last_block;
                let threshold;
                if ((!(isNaN(parseInt(params.first_block)))) && (!(isNaN(parseInt(params.last_block)))) && (!(isNaN(parseInt(params.threshold))))) {
                    first_block = parseInt(params.first_block);
                    last_block = parseInt(params.last_block);
                    threshold = parseInt(params.threshold);
                    document.getElementById("selectedLevel_begin").value = first_block;
                    document.getElementById("selectedLevel_end").value = last_block;
                    document.getElementById("selectedThreshold").value = threshold;

                    let dict_data = populate_v1(server_adress, first_block, last_block).then(dict_data => {
                        document.getElementById("progress").textContent = "Extracting data";
                        let t_op_valide_array = delays_distribution_of_operations(dict_data);
                        document.getElementById("progress").textContent = "Computing data";
                        let endorsing_power = get_endorsing_power(dict_data)
                        let t_op_valide_dict = delays_distribution_of_operations(dict_data);
                        let results = TimeForPercIntegration(threshold, t_op_valide_dict[1])
                        document.getElementById("progress").textContent = "Preparing visualization";
                        chart_time_required_endorsments(results);
                        document.getElementById("progress").textContent = "Finished";

                    })

                } else {
                    var a = getHead(server_adress); // https://stackoverflow.com/questions/28250680/how-do-i-access-previous-promise-results-in-a-then-chain
                    var b = a.then(level => {
                        return populate_v1(server_adress, level - 50, level);
                    });
                    threshold = 70;

                    Promise.all([a, b]).then(([block_value, dict_data]) => {
                        document.getElementById("selectedLevel_begin").value = block_value - 50;
                        document.getElementById("selectedLevel_end").value = block_value;
                        document.getElementById("selectedThreshold").value = threshold;

                        document.getElementById("progress").textContent = "Extracting data";
                        let t_op_valide_array = delays_distribution_of_operations(dict_data);
                        document.getElementById("progress").textContent = "Computing data";
                        let endorsing_power = get_endorsing_power(dict_data)
                        let t_op_valide_dict = delays_distribution_of_operations(dict_data);
                        console.log(t_op_valide_dict)
                        let results = TimeForPercIntegration(threshold, t_op_valide_dict[1]);
                        console.log(results)
                        document.getElementById("progress").textContent = "Preparing visualization";
                        chart_time_required_endorsments(results);
                        document.getElementById("progress").textContent = "Finished";

                    });
                }
                $('#submit_').mouseup(async function (e) {
                    if ((!(isNaN(document.getElementById('selectedLevel_begin').value))) && (!(isNaN(document.getElementById('selectedLevel_end').value))) && (!(isNaN(document.getElementById('selectedThreshold').value)))) {
                        let location_web = String(window.location.href).split('?')[0];
                        window.location = location_web + "?threshold=" + document.getElementById('selectedThreshold').value + "&first_block=" + document.getElementById('selectedLevel_begin').value + "&last_block=" + document.getElementById('selectedLevel_end').value;
                    }
                });

            } catch (e) {
                console.log(e)
            }
        }
        main()

    </script>
</body>